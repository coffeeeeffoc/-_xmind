[toc]
# 输入url之后流程

## 用户输入

### 如果是搜索内容，地址栏会使用浏览器默认的搜索引擎

### 如果判断输入内容符合 URL 规则，比如输入的是 time.geekbang.org，那么地址栏会根据规则，把这段内容加上协议，合成为完整的 URL

### 如果当前页面有beforeunload事件，且事件返回值不为null或undefined，则弹框提示是否离开当前页面

### 若没有beforeunload事件或者同意之后，则后续流程

### 标签页上的图标便进入了加载状态，此时之前的页面并没有被替换，需要等到后续的提交文档阶段，页面内容才会被替换

##  URL 请求过程

### 浏览器进程会通过进程间通信（IPC）把 URL 请求发送至网络进程

### 网络进程接收到 URL 请求后，发起真正的 URL 请求流程

### 网络进程会查找本地缓存是否缓存了该资源

### 如果有缓存资源，那么直接返回资源给浏览器进程

### 如果在缓存中没有查找到资源，那么直接进入网络请求流程

### 网络请求

- 进行 DNS 解析，以获取请求域名的服务器 IP 地址
- 如果请求协议是 HTTPS，那么还需要建立 TLS 连接
- 利用 IP 地址和服务器建立 TCP 连接
- 连接建立之后，浏览器端会构建请求行、请求头等信息，并把和该域名相关的 Cookie 等数据附加到请求头中，然后向服务器发送构建的请求信息
- tcp连接

	- 三次握手
	- 应用层-网络层-传输层-数据链路层-物理层
	- 四次挥手

- 服务器接收到请求信息后，会根据请求信息生成响应数据（包括响应行、响应头和响应体等信息），并发给网络进程
- 网络进程解析响应头

	- 如果状态码是 301 或者 302，需要浏览器重定向到其他 URL。这时网络进程会从响应头的 Location 字段里面读取重定向的地址，然后再发起新的 HTTP 或者 HTTPS 请求，一切又重头开始了
	- 如果响应行是 200，浏览器继续处理该请求

### 响应数据类型处理

- 如果Content-type 字段的值是 text/html或者文本类型，则准备渲染进程
- 如果Content-type字段的值被判断为下载类型(比如application/octet-stream字节流)，则请求被提交给浏览器的下载管理器，同时URL 请求的导航流程

## 准备渲染进程

### 如果页面是同一站点打开的新的tab标签页，则复用父页面的渲染进程

### 如果手输入url，或者不同站点打开的tab标签页，则新建一个渲染进程

## 提交文档阶段

### 浏览器进程接收到网络进程的响应头数据之后，便向渲染进程发起“提交文档”的消息

### 渲染进程和网络进程建立传输数据的“管道”

### 等文档数据传输完成之后，渲染进程会返回“确认提交”的消息给浏览器进程

### 浏览器进程在收到“确认提交”的消息后，会更新浏览器界面状态，包括了安全状态、地址栏的 URL、前进后退的历史状态，并更新 Web 页面

## 渲染阶段

### 渲染页面

- 构建DOM树
- 样式计算

	- 把 CSS 转换为浏览器能够理解的结构

		- 存放在document.styleSheets

	- 转换样式表中的属性值，使其标准化
	- 计算出 DOM 树中每个节点的具体样式

		- CSS 的继承规则和层叠规则

			- 继承

				- 有些属性能继承，则属性值 | parent | userAgent
				- 不能继承的属性，则属性值 | userAgent

			- 层叠

				- 正常按照样式表中定义的结构

- 布局阶段

	- 创建布局树

		- 可见节点加入
		- 不可见节点忽略

			- display:none

	- 布局计算

- 分层

	- 图层树（layer tree）

		- 拥有层叠上下文属性的元素会被提升为单独的一层
		- 需要剪裁（clip）的地方也会被创建为图层
		- 如果出现滚动条，滚动条也会被提升为单独的层

- 绘制  
- 分块

	- 视口（viewport

- 光栅化

	- 将图块转换为位图

- 合成

	- 一旦所有图块都被光栅化后，合成线程就会生成一个绘制图块的命令

- 显示

	- 页面内容绘制到内存，再显示到屏幕

### 页面生成完成，渲染进程会发送一个消息给浏览器进程，浏览器接收到消息后，会停止标签图标上的加载动画

