# 模块机制

## CommonJS规范

### 1.模块引用

- var math = require('math')

### 2.模块定义

- exports对象用于到处当前模块的变量或方法，并且是唯一导出的出口
- 直接把属性定义在exports对象上即可

### 3.模块标识

- 必须是小驼峰命名的字符串，或者.   ..开头的相对路径或绝对路径

## Node的模块实现

### 引入步骤

- 1.路径分析
- 2.文件定位
- 3.编译执行

### 分类

- 核心模块

  Node提供的

	- 部分模块是直接加载进内存，省去了文件定位和编译执行的步骤

- 文件模块

  用户编写的

	- 运行时动态加载
	- 需要完整的路径分析、文件定位、编译执行

### 实现

- 优先从缓存加载

	- 对比浏览器

		- 浏览器只缓存文件
		- Node缓存编译和执行后的对象

	- 核心模块和文件模块相同点

		- 一律缓存优先

	- 核心模块的缓存检查先于文件模块的缓存检查

- 路径分析和文件定位

	- 模块标识符

		- 分类

			- 核心模块
			- .或者..开头的相对路径文件模块
			- /开头的绝对路径文件模块
			- 费路径形式的文件模块，如自定义的connect模块

		- 加载速度

			- 核心模块>路径文件模块>自定义模块

		- 查找规则

			- 当前目录下的node_modules目录
			- 父目录下的node_modules目录
			- 父目录的父目录的node_modules目录
			- ...逐级查找

	- 文件定位

		- 文件扩展名分析

			- 如果没有扩展名，会按照.js、.json、.node的次序补足
			- 性能问题

				- 由于同步阻塞式判断文件扩展名是否存在，所以带上扩展名会加快速度

		- 目录分析和包

			- 如果扩展名分析没找到文件却找到一个目录，则再依次查找右侧文件，直到找到文件

				- package.json
				- index.js
				- index.json
				- index.node

	- 模块编译

		- .js文件

			- 通过fs模块同步读取文件后编译执行

				- 编译过程中，会在文件头尾依次添加

					- (function(exports, require, module, __filename, __dirname){\n
					- \n});

		- .node文件

			- 用c/c++编写的扩展文件，通过dlopen()方法加载

		- .json文件

			- 通过fs模块同步读取文件后，用JSON.parse()解析返回结果

		- 其他扩展文件

			- 被当做js文件载入

## 分支主题 3

